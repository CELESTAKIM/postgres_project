<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kenya GIS Portal - Enhanced</title>

<!-- Bootstrap 5 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css"/>

<style>
  body, html { height: 100%; margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;}
  #map { height: 100vh; }
  .sidebar {
    background-color: #f9f9f9;
    overflow-y: auto;
    height: 100vh;
    border-right: 1px solid #ddd;
    padding: 10px;
  }
  .layer-card {
    border: 1px solid #ddd;
    border-radius: 5px;
    margin-bottom: 12px;
    padding: 8px 12px;
    box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
  }
  .color-square {
    width: 20px;
    height: 20px;
    border-radius: 3px;
    border: 1px solid #333;
    display: inline-block;
    margin-left: 8px;
    vertical-align: middle;
  }
  .btn-group-custom {
    margin-top: 8px;
    gap: 5px;
  }
  #layersList {
    max-height: 45vh;
    overflow-y: auto;
  }
  #tableArea {
    margin-top: 15px;
    max-height: 45vh;
    overflow-y: auto;
  }
  .selected-row {
    background-color: #ffe066 !important;
  }
  .footer {
    background: #343a40;
    color: white;
    padding: 10px 20px;
    text-align: center;
  }
</style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Kenya GIS Portal</a>
    <button class="btn btn-light btn-sm" id="uploadBtn" data-bs-toggle="modal" data-bs-target="#uploadModal">Upload Layer</button>
  </div>
</nav>

<div class="container-fluid">
  <div class="row g-0">

    <!-- Sidebar -->
    <div class="col-lg-4 sidebar">

      <h5 class="mt-2">Available Layers</h5>
      <div id="layersList"></div>

      <hr />

      <h5>Attribute Table</h5>
      <div id="tableArea">
        <p class="text-muted">Select a layer and click "View Attributes" to see its data.</p>
      </div>

      <div class="mt-3">
        <button id="downloadSelected" class="btn btn-success btn-sm" disabled>Download Selected Features</button>
        <button id="mergeSelected" class="btn btn-warning btn-sm" disabled>Merge & Download Selected</button>
      </div>
    </div>

    <!-- Map -->
    <div class="col-lg-8 p-0">
      <div id="map"></div>
    </div>

  </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form id="uploadForm" enctype="multipart/form-data">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="uploadModalLabel">Upload Shapefile (zip)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="shpFile" class="form-label">Choose zipped shapefile archive (.zip)</label>
            <input class="form-control" type="file" id="shpFile" name="file" accept=".zip" required/>
          </div>
          <div class="mb-3">
            <label for="tablename" class="form-label">New Layer Table Name</label>
            <input class="form-control" type="text" id="tablename" name="tablename" placeholder="Use letters, digits, underscore only" required/>
          </div>
          <small class="text-muted">Once uploaded successfully, your layer will appear in the layer list and map.</small>
          <div id="uploadStatus" class="mt-2"></div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Upload</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- JS libs -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
const LAYERS = {{ layers | tojson }};
let leafletLayers = {};
let geojsonCache = {};
let activeLayerKey = null;
let highlightedFeature = null;
let selectedRows = {}; // { layerKey: Set of selected row ids }

const map = L.map('map').setView([0.0236, 37.9062], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

function assignLayerColor(key) {
  return LAYERS[key]?.color || '#007bff';
}

function addLayerToMap(key) {
  fetch(`/data/${key}`).then(r => r.json()).then(geojson => {
    if (geojson.error) {
      console.warn("Layer fetch error", geojson.error);
      return;
    }
    if (leafletLayers[key]) map.removeLayer(leafletLayers[key]);

    let style = {
      color: assignLayerColor(key),
      weight: 2,
      fillOpacity: 0.4,
    };

    let layer = L.geoJSON(geojson, {
      style: style,
      pointToLayer: function(feature, latlng) {
        if (feature.geometry.type === 'Point') {
          return L.circleMarker(latlng, {
            radius: 6,
            fillColor: assignLayerColor(key),
            color: '#000',
            weight: 1,
            opacity: 1,
            fillOpacity: 0.9
          });
        }
        return L.geoJSON.geometryToLayer(feature);
      },
      onEachFeature: function(feature, layer) {
        let props = feature.properties || {};
        let popupContent = '<div style="max-height:150px; overflow:auto;">';
        for (const [k,v] of Object.entries(props)) {
          popupContent += `<b>${k}</b>: ${v}<br>`;
        }
        popupContent += '</div>';
        layer.bindPopup(popupContent);
      }
    }).addTo(map);

    leafletLayers[key] = layer;
    geojsonCache[key] = geojson;
  });
}

function buildLayerList() {
  const container = $('#layersList');
  container.empty();

  Object.keys(LAYERS).forEach(key => {
    let color = assignLayerColor(key);
    const card = $(`
      <div class="layer-card">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <input type="checkbox" class="layer-toggle" data-key="${key}" checked />
            <strong>${LAYERS[key].title}</strong>
            <span class="color-square" style="background-color:${color}"></span>
          </div>
          <div class="btn-group btn-group-sm btn-group-custom">
            <button class="btn btn-outline-primary view-attributes" data-key="${key}">View Attributes</button>
            <button class="btn btn-outline-secondary zoom-to-layer" data-key="${key}">Zoom</button>
          </div>
        </div>
      </div>
    `);
    container.append(card);
  });
}

$(document).ready(() => {
  buildLayerList();
  Object.keys(LAYERS).forEach(addLayerToMap);

  // Toggle layers
  $(document).on('change', '.layer-toggle', function() {
    const key = $(this).data('key');
    if ($(this).is(':checked')) {
      if (leafletLayers[key]) map.addLayer(leafletLayers[key]);
      else addLayerToMap(key);
    } else {
      if (leafletLayers[key]) map.removeLayer(leafletLayers[key]);
    }
  });

  // Zoom to layer
  $(document).on('click', '.zoom-to-layer', function() {
    const key = $(this).data('key');
    if (!leafletLayers[key]) return;
    map.fitBounds(leafletLayers[key].getBounds(), {padding: [20, 20]});
  });

  // View attributes
  $(document).on('click', '.view-attributes', function() {
    const key = $(this).data('key');
    activeLayerKey = key;
    loadAttributeTable(key);
  });

  // Attribute table row selection logic
  $('#tableArea').on('change', '.row-select', function() {
    const rowid = parseInt($(this).closest('tr').data('rowid'));
    if (!selectedRows[activeLayerKey]) selectedRows[activeLayerKey] = new Set();
    if (this.checked) {
      selectedRows[activeLayerKey].add(rowid);
      $(this).closest('tr').addClass('selected-row');
    } else {
      selectedRows[activeLayerKey].delete(rowid);
      $(this).closest('tr').removeClass('selected-row');
    }
    updateDownloadMergeButtons();
  });

  // Download selected features
  $('#downloadSelected').click(() => {
    if (!activeLayerKey) return alert('Select a layer and view attributes first');
    const selected = selectedRows[activeLayerKey] ? Array.from(selectedRows[activeLayerKey]) : [];
    if (!selected.length) return alert('No features selected');
    downloadSelectedFeatures(activeLayerKey, selected);
  });

  // Merge selected features from all layers
  $('#mergeSelected').click(() => {
    if (Object.keys(selectedRows).length === 0) return alert('No features selected from any layer');
    const layersToSend = [];
    for (const [layer, rowset] of Object.entries(selectedRows)) {
      if (rowset.size > 0) layersToSend.push({layer: layer, selected: Array.from(rowset)});
    }
    if (!layersToSend.length) return alert('No features selected');
    mergeSelectedLayers(layersToSend);
  });

  // Upload shapefile form submit
  $('#uploadForm').submit(function(e){
    e.preventDefault();
    $('#uploadStatus').html('');
    const formData = new FormData(this);

    $.ajax({
      url: '/upload',
      type: 'POST',
      data: formData,
      processData: false,
      contentType: false,
      success: res => {
        if (res.error) {
          $('#uploadStatus').html('<div class="alert alert-danger">'+res.error+'</div>');
        } else {
          $('#uploadStatus').html('<div class="alert alert-success">'+res.success+'</div>');
          // Refresh layers list & map
          fetch('/').then(r => r.text()).then(html => {
            // Just reload the page to refresh layers (simplest way)
            window.location.reload();
          });
        }
      },
      error: xhr => {
        $('#uploadStatus').html('<div class="alert alert-danger">Upload failed: '+xhr.responseJSON?.error || xhr.statusText+'</div>');
      }
    });
  });
});

function loadAttributeTable(layerKey) {
  $('#tableArea').html('<p>Loading attributes...</p>');
  selectedRows[layerKey] = new Set();
  updateDownloadMergeButtons();

  $.getJSON(`/attributes/${layerKey}`, function(data) {
    if (data.error) {
      $('#tableArea').html('<div class="alert alert-danger">Failed to load attributes: '+data.error+'</div>');
      return;
    }
    let columns = data.columns;
    let rows = data.rows;

    let html = `<table id="attrTable" class="table table-striped table-bordered table-sm" style="width:100%">
      <thead><tr><th>Select</th>`;
    columns.forEach(col => {
      html += `<th>${col}</th>`;
    });
    html += '</tr></thead><tbody>';

    rows.forEach(row => {
      html += `<tr data-rowid="${row._rowid}"><td><input type="checkbox" class="row-select"/></td>`;
      columns.forEach(col => {
        html += `<td>${row[col]}</td>`;
      });
      html += '</tr>';
    });

    html += '</tbody></table>';
    $('#tableArea').html(html);

    $('#attrTable').DataTable({
      scrollY: "300px",
      scrollCollapse: true,
      paging: false,
      info: false,
      searching: true,
      columnDefs: [{
        orderable: false,
        targets: 0
      }]
    });
  });
}

function updateDownloadMergeButtons(){
  const selectedCount = activeLayerKey && selectedRows[activeLayerKey] ? selectedRows[activeLayerKey].size : 0;
  $('#downloadSelected').prop('disabled', !selectedCount);
  const anySelected = Object.values(selectedRows).some(s => s.size > 0);
  $('#mergeSelected').prop('disabled', !anySelected);
}

function downloadSelectedFeatures(layer, selected) {
  fetch('/download', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({layer: layer, selected: selected})
  }).then(resp => {
    if (!resp.ok) throw new Error('Download failed');
    return resp.blob();
  }).then(blob => {
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${layer}_selection.zip`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    window.URL.revokeObjectURL(url);
  }).catch(err => alert(err.message));
}

function mergeSelectedLayers(layersToSend) {
  fetch('/merge_layers', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({layers: layersToSend})
  }).then(resp => {
    if (!resp.ok) throw new Error('Merge failed');
    return resp.blob();
  }).then(blob => {
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `merged_selection.zip`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    window.URL.revokeObjectURL(url);
  }).catch(err => alert(err.message));
}
</script>

<footer class="footer mt-3">
  <small>&copy; 2025 Kenya GIS Portal | Developed by Kimathi Joram </small>
</footer>
</body>
</html>
